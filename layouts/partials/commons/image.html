{{/* DOM Params  */}}
{{- $alt := .alt | default "" -}}
{{- $lazy := .lazy | default true -}}
{{- $class := .class | default false -}}
{{- $picture_class := .picture_class | default false -}}
{{- $itemprop := .itemprop | default false -}}

{{/* Image Params  */}}
{{- $desktop_size := .desktop | default false -}}
{{- $mobile_size := .mobile | default false -}}
{{- $mobile_size_2x := false -}}
{{- $mobile_size_3x := false -}}
{{- if $mobile_size -}}
  {{- $mobile_size_2x = partial "func/GetMultiplyImage" (dict "size" $mobile_size) -}}
  {{- $mobile_size_3x = partial "func/GetMultiplyImage" (dict "size" $mobile_size "multiply" 3) -}}
{{- end -}}
{{- $crop := .crop | default "Center" -}}
{{- $file := .src -}}
{{- $file_mobile := .src_mobile | default $file -}}
{{- if .static -}}
  {{- $file = delimit (slice "/static" .src) "" -}}
  {{- if $file_mobile -}}
    {{- $file_mobile = delimit (slice "/static" .src_mobile) "" -}}
  {{- end -}}
{{- end -}}
{{- $filter := site.Params.image.filter | default "Box" -}}
{{- if or .screenshot .linear -}}
  {{- $filter = "Linear" -}}
{{- end -}}

{{/* Get Images */}}
{{ $imageRenderParams := dict 
    "file" $file 
    "file_mobile" $file_mobile 
    "desktop_size" $desktop_size 
    "mobile_size" $mobile_size 
    "mobile_size_2x" $mobile_size_2x 
    "mobile_size_3x" $mobile_size_3x 
    "crop" $crop 
    "filter" $filter
}}
{{- $imageParams := false -}}
{{- $domParams := dict "alt" $alt "lazy" $lazy "class" $class "itemprop" $itemprop -}}
{{- if in $file "ucarecdn" -}}
  {{- $imageParams =  partial "commons/image/uploadcare" $imageRenderParams }}
{{- else -}}
  {{- $imageParams = partial "commons/image/hugo" $imageRenderParams -}}
{{- end -}}
{{- $params := merge $imageParams $domParams -}}

{{/* Display image  */}}
{{- with $params }}
  <picture {{- with $picture_class }} class="{{ . }}"{{ end }}>
    {{- if .image_desktop_webp }}
      <source srcset="{{ .image_desktop_webp }}" type="image/webp"{{ if .image_mobile}} media="(min-width: 577px)"{{ end }}>
    {{- end -}}
    {{ if .image_mobile }}
      {{- if .image_mobile_webp }}
        <source srcset="{{ .image_mobile_webp }}, {{ .image_mobile_webp_2x }} 2x, {{ .image_mobile_webp_3x }} 3x" type="image/webp" media="(max-width: 576px)">
      {{ end -}}
      <source srcset="{{ .image_mobile }}, {{ .image_mobile_2x }} 2x, {{ .image_mobile_3x }} 3x" type="image/jpg" media="(max-width: 576px)">
    {{ end -}}
    <img src="{{ .image_desktop }}" alt="{{ $alt }}" 
      {{- with .image_width }} width="{{ . }}"{{ end -}} 
      {{ with .image_height }} height="{{ . }}"{{ end -}} 
      {{ if $lazy }} loading="lazy" decoding="async"{{ else }} fetchpriority="high"{{ end -}}
      {{ with $class }} class="{{ . }}"{{ end -}}
      {{ with $itemprop }} itemprop="{{ . }}"{{ end }}>
  </picture>
{{ end }}